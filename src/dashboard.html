<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DepTrack Dashboard</title>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; script-src 'unsafe-inline' vscode-resource: data: https://cdn.jsdelivr.net; style-src 'unsafe-inline'; img-src data:;">
  <!-- Load Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    :root{--bg-dark:#1a1a2e;--bg-darker:#131325;--card-bg:#212142;--accent:#4ecca3;--text-light:#e0e1dd;--shadow:rgba(0,0,0,0.5);--radius:8px;--gap:1rem;--transition:0.2s;}
    body{display:flex;height:100vh;font-family:'Segoe UI',sans-serif;background:var(--bg-dark);color:var(--text-light);overflow:hidden;}
    aside#aside{width:300px;background:var(--bg-darker);padding:var(--gap);display:flex;flex-direction:column;gap:0.75rem;}
    aside#aside h2{font-size:1.25rem;text-align:center;color:var(--accent);}
    .email-row{display:flex;gap:0.5rem;align-items:center;}
    .email-row input{flex:1;padding:0.5rem;border-radius:var(--radius);border:1px solid #2e2e4e;background:var(--card-bg);color:var(--text-light);}
    .email-row button{padding:0.5rem 1rem;border:none;border-radius:var(--radius);background:var(--accent);color:var(--text-light);cursor:pointer;}
    aside#aside button{display:flex;align-items:center;gap:0.75rem;background:none;border:none;color:var(--text-light);padding:0.75rem;font-size:1rem;border-radius:var(--radius);cursor:pointer;}
    aside#aside button:hover,aside#aside button.active{background:rgba(78,204,163,0.15);}
    .spinner{display:none;margin-left:0.5rem;}
    .spinner.spin{display:inline-block;animation:spin 1s linear infinite;}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    main#main{flex:1;display:flex;flex-direction:column;overflow:auto;}
    header#header{padding:var(--gap) var(--gap) 0;}
    header#header h1{font-size:1.5rem;color:var(--text-light);}
    #controls{display:flex;align-items:center;gap:0.5rem;padding:0 var(--gap) var(--gap);background:var(--bg-darker);}
    #viewSelect,#scanView,#scanAll{padding:0.5rem;border-radius:var(--radius);border:1px solid #2e2e4e;background:var(--card-bg);color:var(--text-light);cursor:pointer;}
    section#cards{padding:var(--gap);display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:var(--gap);flex:1;overflow-y:auto;}
    .card{background:var(--card-bg);border-radius:var(--radius);box-shadow:0 2px 8px var(--shadow);display:flex;flex-direction:column;transition:transform var(--transition);}
    .card:hover{transform:translateY(-4px);}
    .card header{padding:var(--gap);font-weight:bold;font-size:1rem;border-bottom:1px solid #2e2e4e;color:var(--accent);}
    .card .content{padding:var(--gap);flex:1;overflow:hidden;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:0.5rem;text-align:left;font-size:0.9rem;border-bottom:1px solid #2e2e4e;color:var(--text-light);}
    pre{white-space:pre-wrap;font-family:monospace;font-size:0.8rem;max-height:200px;overflow:auto;}
    canvas{width:100% !important;height:200px !important;}
    footer#footer{background:var(--card-bg);padding:var(--gap);text-align:center;font-size:0.95rem;color:var(--accent);border-top:1px solid #2e2e4e;}
    .status{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle;}
    .status.good{background:#4ecca3;}
    .status.warning{background:gold;}
    .status.critical{background:#ff4c4c;}
    .card[data-view="secret"] .content,
    .card[data-view="license"] .content{overflow-x:auto;}
    #secretTable,#licenseTable{min-width:600px;}
    .license-issues{list-style:none;padding-left:1rem;}
    .license-issues li::before{content:"‚Ä¢ ";}
    .card[data-view="chatbot"] .content{display:flex;flex-direction:column;}
    #chatContainer{flex:1;overflow:auto;margin-bottom:1rem;}
    .input-row{display:flex;gap:0.5rem;}
    .copyright{margin-top:auto;text-align:center;font-size:0.8rem;color:#666;}
  </style>
</head>
<body>
  <aside id="aside">
    <h2>DepTrack</h2>
    <div class="email-row">
      <input id="emailInput" type="email" placeholder="you@example.com" />
      <button id="sendInputEmail">Send</button>
    </div>
    <button id="refresh" class="active">üîÑ Refresh <span id="spinner" class="spinner">‚è≥</span></button>
    <button id="health">ü©∫ Health Check</button>
    <button id="email">‚úâÔ∏è Email Alert</button>
    <button id="csv">üìë Export CSV</button>
    <button id="pdf">üìÑ Export PDF</button>
    <div class="copyright">¬© Aman Kumar</div>
  </aside>
  <main id="main">
    <header id="header"><h1>Security & Secret Scanning</h1></header>
    <div id="controls">
      <select id="viewSelect">
        <option value="outdated">Outdated Packages</option>
        <option value="vuln">Vulnerabilities</option>
        <option value="suggestions">Fix Suggestions</option>
        <option value="license">License Issues</option>
        <option value="eslint">ESLint Issues</option>
        <option value="duplication">Code Duplication</option>
        <option value="complexity">Complexity</option>
        <option value="secret">Secret Scanning</option>
        <option value="depgraph">Dependency Graph</option>
        <option value="sonar">Sonar Report</option>
      </select>
      <button id="scanView">Scan View</button>
      <button id="scanAll">Scan All</button>
    </div>
    <section id="cards">
      <div class="card" data-view="log">
        <header>Process Log</header>
        <div class="content"><pre id="logOutput"></pre></div>
      </div>
      <div class="card" data-view="chatbot">
        <header>Chatbot</header>
        <div class="content">
          <div id="chatContainer"></div>
          <div class="input-row">
            <input id="chatInput" type="text" placeholder="Type a message‚Ä¶"
                   style="flex:1;padding:0.5rem;border:none;border-radius:var(--radius);" />
            <button id="sendChat"
                    style="padding:0.5rem 1rem;border:none;border-radius:var(--radius);
                           background:var(--accent);color:var(--text-light);cursor:pointer;">
              Send
            </button>
          </div>
        </div>
      </div>
      <div class="card" data-view="outdated">
        <header>Outdated Packages</header>
        <div class="content">
          <table id="outdatedTable">
            <thead><tr><th></th><th>Package</th><th>Current</th><th>Latest</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card" data-view="vuln">
        <header>Vulnerabilities</header>
        <div class="content">
          <table id="vulnTable">
            <thead><tr><th>Package</th><th>Severity</th><th>Title</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card" data-view="suggestions">
        <header>Fix Suggestions</header>
        <div class="content">
          <table id="suggestionsTable">
            <thead><tr><th>Category</th><th>Suggestion</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card" data-view="license">
        <header>License Issues</header>
        <div class="content">
          <table id="licenseTable">
            <thead><tr><th>Package</th><th>License(s)</th><th>Issues</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card" data-view="eslint">
        <header>ESLint Issues</header>
        <div class="content">
          <table id="eslintTable">
            <thead><tr><th>File</th><th>Issues</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card" data-view="duplication">
        <header>Code Duplication</header>
        <div class="content">
          <table id="dupTable">
            <thead><tr><th>File A</th><th>Line A</th><th>File B</th><th>Line B</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card" data-view="complexity">
        <header>Complexity</header>
        <div class="content"><canvas id="complexityChart"></canvas></div>
      </div>
      <div class="card" data-view="secret">
        <header>Secret Scanning</header>
        <div class="content">
          <table id="secretTable">
            <thead><tr><th>File</th><th>Line</th><th>Rule</th><th>Match</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card" data-view="depgraph">
        <header>Dependency Graph</header>
        <div class="content"><canvas id="dep-graph"></canvas></div>
      </div>
      <div class="card" data-view="sonar">
        <header>Sonar Report</header>
        <div class="content"><pre id="sonarOutput"></pre></div>
      </div>
    </section>
    <footer id="footer">ISE END SEM PROJECT</footer>
  </main>
  <script>
    const vscode = acquireVsCodeApi();
    let complexityChart, depChart;

    function showSpinner() { document.getElementById('spinner').classList.add('spin'); }
    function hideSpinner() { document.getElementById('spinner').classList.remove('spin'); }

    const btnMap = {
      refresh: 'refresh',
      health:  'healthCheck',
      email:   'sendEmail',
      csv:     'exportCSV',
      pdf:     'exportPDF'
    };

    ['refresh','health','email','csv','pdf'].forEach(id => {
      document.getElementById(id).onclick = () => {
        document.querySelector('button.active')?.classList.remove('active');
        document.getElementById(id).classList.add('active');
        if (id === 'refresh') showSpinner();
        vscode.postMessage({ command: btnMap[id], email: document.getElementById('emailInput').value });
      };
    });

    document.getElementById('sendInputEmail').onclick = () => {
      const e = document.getElementById('emailInput');
      if (!e.checkValidity()) return alert('Enter a valid email');
      vscode.postMessage({ command: 'sendEmail', email: e.value });
    };

    const cards = document.querySelectorAll('.card[data-view]');
    document.getElementById('scanView').onclick = () => {
      const sel = document.getElementById('viewSelect').value;
      cards.forEach(c => {
        c.style.display = (c.dataset.view==='log'||c.dataset.view==='chatbot'||c.dataset.view===sel) ? 'flex' : 'none';
      });
    };
    document.getElementById('scanAll').onclick = () => cards.forEach(c => c.style.display='flex');

    window.addEventListener('message', e => {
      const msg = e.data;
      if (msg.command==='logUpdate') {
        document.getElementById('logOutput').textContent = msg.payload.join('\n');
        return;
      }
      if (msg.command==='updateData' && msg.payload) {
        hideSpinner();
        const d = msg.payload;

        // Outdated
        const tbO = document.querySelector('#outdatedTable tbody'); tbO.innerHTML = '';
        Object.entries(d.outdated||{}).forEach(([p,i]) => {
          const tr = tbO.insertRow();
          tr.innerHTML = `<td><span class="status ${i.status}"></span></td><td>${p}</td><td>${i.current}</td><td>${i.latest}</td>`;
        });

        // Vulnerabilities
        const tbV = document.querySelector('#vulnTable tbody'); tbV.innerHTML = '';
        Object.entries(d.vuln||{}).forEach(([p,v]) => {
          const tr = tbV.insertRow();
          tr.innerHTML = `<td>${p}</td><td>${v.severity}</td><td>${v.title}</td>`;
        });

        // Suggestions
        const tbS = document.querySelector('#suggestionsTable tbody'); tbS.innerHTML = '';
        (d.suggestions||[]).forEach(s => {
          const tr = tbS.insertRow();
          tr.innerHTML = `<td>${s.category}</td><td>${s.suggestion}</td>`;
        });

        // License
        const tbL = document.querySelector('#licenseTable tbody'); tbL.innerHTML = '';
        (d.licenseIssues||[]).forEach(x => {
          const tr = tbL.insertRow();
          tr.innerHTML = `<td>${x.pkg}</td><td>${x.licenses.join(', ')}</td><td><ul class="license-issues">${x.issues.map(i=>`<li>${i}</li>`).join('')}</ul></td>`;
        });

        // ESLint
        const tbE = document.querySelector('#eslintTable tbody'); tbE.innerHTML = '';
        Object.entries(d.eslintCounts||{}).forEach(([f,c]) => {
          const tr = tbE.insertRow();
          tr.innerHTML = `<td>${f}</td><td>${c} issues</td>`;
        });

        // Duplication
        const tbD = document.querySelector('#dupTable tbody'); tbD.innerHTML = '';
        (d.duplicationDetails||[]).forEach(m => {
          const tr = tbD.insertRow();
          tr.innerHTML = `<td>${m.fileA}</td><td>${m.lineA}</td><td>${m.fileB}</td><td>${m.lineB}</td>`;
        });

        // Complexity Chart
        const cc = document.querySelector('.card[data-view="complexity"] .content');
        if (!d.complexity?.length) {
          cc.innerHTML = '<div>No complexity data</div>';
        } else {
          cc.innerHTML = '<canvas id="complexityChart"></canvas>';
          const ctx = document.getElementById('complexityChart').getContext('2d');
          complexityChart?.destroy();
          complexityChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: d.complexity.map(r => r.path),
              datasets: [{ label: 'Cyclomatic', data: d.complexity.map(r => r.aggregate?.cyclomatic || 0) }]
            },
            options: { responsive: true, maintainAspectRatio: false }
          });
        }

        // Secret Scanning
        const tbS2 = document.querySelector('#secretTable tbody'); tbS2.innerHTML = '';
        (d.secrets||[]).forEach(s => {
          const tr = tbS2.insertRow();
          tr.innerHTML = `<td>${s.file}</td><td>${s.line}</td><td>${s.rule}</td><td style="font-family:monospace;">${s.match}</td>`;
        });

        // Dependency Graph Chart
        const ctx2 = document.getElementById('dep-graph').getContext('2d');
        depChart?.destroy();
        const labels = Object.keys(d.depGraph||{});
        const data   = labels.map(k => {
          const raw = d.depGraph[k].version.replace(/^[^\d]*/, '');
          const num = parseFloat(raw);
          return isNaN(num) ? 0 : num;
        });
        depChart = new Chart(ctx2, {
          type: 'bar',
          data: { labels, datasets: [{ label: 'Versions', data }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });

        // Sonar Output
        const so = d.sonar || {};
        document.getElementById('sonarOutput').textContent = so.error
          ? `‚ùå Scan failed:\n${so.error}`
          : `Quality Gate: ${so.qualityGate}`;

        // Chat History
        const ctr = document.getElementById('chatContainer'); ctr.innerHTML = '';
        (d.chatHistory||[]).forEach(c => {
          const div = document.createElement('div');
          div.textContent = `${c.from}: ${c.text}`;
          ctr.appendChild(div);
        });
        ctr.scrollTop = ctr.scrollHeight;
      }

      if (msg.command==='chatResponse' && msg.payload) {
        const ctr = document.getElementById('chatContainer');
        const div = document.createElement('div');
        div.textContent = msg.payload.text;
        ctr.appendChild(div);
        ctr.scrollTop = ctr.scrollHeight;
      }
    });

    document.getElementById('sendChat').onclick = () => {
      const txt = document.getElementById('chatInput').value.trim();
      if (!txt) return;
      vscode.postMessage({ command: 'chat', text: txt });
      document.getElementById('chatInput').value = '';
    };
  </script>
</body>
</html>
